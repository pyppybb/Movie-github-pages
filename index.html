
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <title>ç”µå½±æ¸…å•</title>

  <!-- PWA ç›¸å…³ï¼ˆiOS å…¨å± + å›¾æ ‡ ç­‰ï¼‰ -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#ff7eb3" />
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="apple-mobile-web-app-title" content="å°ç‹—çš„ç”µå½±æ¸…å•"/>
  <!-- iOS æ·»åŠ åˆ°ä¸»å±å¹•çš„å›¾æ ‡ï¼Œéœ€æ ¹æ®è‡ªå·±å›¾æ ‡è·¯å¾„æ¥ -->
  <link rel="apple-touch-icon" sizes="180x180" href="icons/192.png" />

  <!-- å¯é€‰ï¼šå¼•å…¥å¯çˆ±å­—ä½“ Ma Shan Zhengï¼ˆGoogle Fontsï¼‰ -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link 
    href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap" 
    rel="stylesheet"
  />

  <style>
    /**************************************
     * 
     * 1. é»˜è®¤ä¸»é¢˜ / åŸºç¡€æ ·å¼
     *    - ä½¿ç”¨ç²‰è‰²ç³» + å¯çˆ±å­—ä½“
     * 
     **************************************/
    body {
      font-family: 'Ma Shan Zheng', 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f8f9fa; /* é»˜è®¤èƒŒæ™¯ */
    }

    header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: linear-gradient(90deg, #ff7eb3, #ff758c);
      color: #fff;
      text-align: center;
      padding: 10px 0;
      font-size: 1.5em;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    nav {
      display: flex;
      justify-content: space-around;
      background: #ff94c2;
      padding: 10px 0;
    }
    nav button {
      padding: 10px 15px;
      border: none;
      border-radius: 20px;
      background: #fff;
      cursor: pointer;
      font-size: 1em;
      transition: all 0.3s ease;
      margin: 3px;
    }
    nav button:hover {
      background: #ffe3ee;
    }

    main {
      padding: 20px;
      padding-bottom: 100px; /* æ ¹æ®footeré«˜åº¦åšé€‚å½“è°ƒæ•´ */
    }

    .section {
      display: none;
    }
    .section.active {
      display: block;
    }

    /* å¡ç‰‡å¸ƒå±€ */
    .movie-list-grid {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
    }

    .movie-card {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      text-align: center;
      position: relative;
    }
    .movie-card button {
      margin: 3px;
    }

    .review-text {
      color: #555;
      font-style: italic;
      margin-top: 6px;
      white-space: pre-line; /* ä¿ç•™æ¢è¡Œ */
    }

    .highlight {
      border: 2px solid red;
    }

    @media (max-width: 600px) {
      nav {
        flex-direction: column;
        align-items: center;
      }
      nav button {
        width: 80%;
        margin: 5px 0;
      }
      .movie-list-grid {
        grid-template-columns: 1fr;
      }
    }

    footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: #ff94c2;
      text-align: center;
      padding: 10px 0;
      box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.2);
      z-index: 9999; 
    }
    footer button {
      margin: 3px;
      padding: 6px 12px;
      border: none;
      border-radius: 20px;
      background: #fff;
      cursor: pointer;
      font-size: 1em;
      transition: all 0.3s ease;
    }
    footer button:hover {
      background: #ffe3ee;
    }

    #stats-container {
      display: flex;
      justify-content: space-around;
      margin-bottom: 20px;
    }
    #stats-container > div {
      flex: 1;
      text-align: center;
      font-size: 1.1em;
      font-weight: bold;
      margin: 0 5px;
    }

    .points-display {
      color: #ff4500; 
      font-weight: bold;
      text-align: center;
      margin: 10px 0;
      font-size: 1.2em;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto; 
      background-color: rgba(0, 0, 0, 0.5);
    }
    .modal-content {
      background-color: #fff;
      margin: 10% auto; 
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
      border-radius: 10px;
      max-height: 80%; 
      overflow-y: auto; 
    }

    .collapsible-header {
      cursor: pointer;
      font-weight: bold;
      background: #ffe3ee;
      padding: 8px;
      border-radius: 5px;
      margin: 5px 0;
    }
    .collapsible-content {
      display: none;
      margin: 5px 0;
    }
    .collapsible-content.show {
      display: block;
    }

    .expired {
      background-color: #ffe0e0; 
      border-color: red;
    }
    .expired-text {
      color: red;
    }

    #sort-filter-modal {
      display: none;
      position: fixed;
      z-index: 12000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,.5);
    }
    #sort-filter-modal .modal-content {
      margin: 10% auto;
      max-width: 400px;
      max-height: 80%;
      overflow-y: auto;
    }

    /**************************************
     * 
     * 2. å…¶ä»–å¯é€‰ä¸»é¢˜: 
     *    - åŸæœ‰: .theme-blue / .theme-green / .theme-dark
     *    - æ–°å¢æ›´å¤šä¸»é¢˜(é«˜çº§æ„Ÿé…è‰²)ï¼š
     *      .theme-adv1 / .theme-adv2 / .theme-adv3 / .theme-adv4 / .theme-adv5
     * 
     **************************************/

    /* åŸæœ‰ä¸»é¢˜: blue */
    body.theme-blue {
      background-color: #e6f7ff; /* æ·¡è“è‰² */
    }
    body.theme-blue header {
      background: linear-gradient(90deg, #4facfe, #00f2fe);
    }
    body.theme-blue nav {
      background: #a0e1eb;
    }
    body.theme-blue footer {
      background-color: #a0e1eb;
    }

    /* åŸæœ‰ä¸»é¢˜: green */
    body.theme-green {
      background-color: #eefff0; /* æ·¡ç»¿è‰² */
    }
    body.theme-green header {
      background: linear-gradient(90deg, #5ee270, #31c853);
    }
    body.theme-green nav {
      background: #98f2aa;
    }
    body.theme-green footer {
      background-color: #98f2aa;
    }

    /* åŸæœ‰ä¸»é¢˜: dark */
    body.theme-dark {
      background-color: #2c2c2c;
      color: #eee;
    }
    body.theme-dark header {
      background: linear-gradient(90deg, #444, #111);
    }
    body.theme-dark nav {
      background: #444;
    }
    body.theme-dark footer {
      background-color: #444;
    }
    body.theme-dark .movie-card {
      background: #3a3a3a;
      border-color: #666;
      color: #ddd;
    }
    body.theme-dark nav button,
    body.theme-dark footer button {
      background: #666;
      color: #fff;
    }
    body.theme-dark nav button:hover,
    body.theme-dark footer button:hover {
      background: #777;
    }

    /* æ–°å¢ä¸»é¢˜: theme-adv1 (ä¾‹å¦‚ #759148, #FFBAAC, #E9EDF0) */
    body.theme-adv1 {
      background-color: #E9EDF0; 
      color: #333;
    }
    body.theme-adv1 header {
      background: linear-gradient(90deg, #759148, #9BBF6E);
    }
    body.theme-adv1 nav {
      background-color: #759148; 
    }
    body.theme-adv1 footer {
      background-color: #759148; 
    }
    body.theme-adv1 .movie-card {
      background-color: #FFBAAC; 
      color: #333;
    }

    /* æ–°å¢ä¸»é¢˜: theme-adv2 (ä¾‹å¦‚ #D2B48C, #DEB887, #F4A460, #FFDEAD) */
    body.theme-adv2 {
      background-color: #FFDEAD; 
      color: #4f3f2d;
    }
    body.theme-adv2 header {
      background: linear-gradient(90deg, #F4A460, #DEB887);
    }
    body.theme-adv2 nav {
      background-color: #D2B48C;
    }
    body.theme-adv2 footer {
      background-color: #D2B48C;
    }
    body.theme-adv2 .movie-card {
      background-color: #ffffff; 
      color: #333;
    }

    /* æ–°å¢ä¸»é¢˜: theme-adv3 (ä¾‹å¦‚ #FF6347, #FFA07A, #FFDAB9, #FFE4E1) */
    body.theme-adv3 {
      background-color: #FFE4E1;
      color: #442D2D;
    }
    body.theme-adv3 header {
      background: linear-gradient(90deg, #FF6347, #FFA07A);
    }
    body.theme-adv3 nav {
      background-color: #FF6347;
    }
    body.theme-adv3 footer {
      background-color: #FF6347;
    }
    body.theme-adv3 .movie-card {
      background-color: #FFDAB9;
      color: #442D2D;
    }

    /* æ–°å¢ä¸»é¢˜: theme-adv4 (ä¾‹å¦‚ #4682B4, #87CEFA, #B0E0E6, #E0FFFF) */
    body.theme-adv4 {
      background-color: #E0FFFF;
      color: #222;
    }
    body.theme-adv4 header {
      background: linear-gradient(90deg, #4682B4, #87CEFA);
    }
    body.theme-adv4 nav {
      background-color: #B0E0E6;
    }
    body.theme-adv4 footer {
      background-color: #B0E0E6;
    }
    body.theme-adv4 .movie-card {
      background-color: #fff;
      color: #333;
    }

    /* æ–°å¢ä¸»é¢˜: theme-adv5 (ä¾‹å¦‚ #6E87B0, #B2C1D6, #EDE5E3, #DBBACB, #B7799E) */
    body.theme-adv5 {
      background-color: #EDE5E3;
      color: #4C4A4A;
    }
    body.theme-adv5 header {
      background: linear-gradient(90deg, #6E87B0, #B2C1D6);
    }
    body.theme-adv5 nav {
      background-color: #DBBACB;
    }
    body.theme-adv5 footer {
      background-color: #DBBACB;
    }
    body.theme-adv5 .movie-card {
      background-color: #ffffff;
      color: #333;
    }
  </style>
</head>
<body>
  <header>ğŸ¬ ç”µå½±æ¸…å• ğŸ¯</header>

  <nav>
    <button onclick="showSection('goal-section')">æ¯å‘¨ç›®æ ‡</button>
    <button onclick="showSection('list-section')">ç”µå½±æ¸…å•</button>
  </nav>

  <main>
    <!-- =========== æ¯å‘¨ç›®æ ‡åŒº =========== -->
    <section id="goal-section" class="section active">
      <h2>ğŸ¯ æ¯å‘¨ç›®æ ‡</h2>

      <div class="points-display">
        å½“å‰ç§¯åˆ†ï¼š<span id="points-value">0</span>
      </div>

      <label for="weekly-goal">è®¾ç½®æœ¬å‘¨ç›®æ ‡ç”µå½±æ•°ï¼š</label>
      <input type="number" id="weekly-goal" value="3" style="width:60px;"/>

      <label for="deadline">ç›®æ ‡æˆªæ­¢æ—¥æœŸï¼š</label>
      <input type="date" id="deadline" />

      <div style="margin:10px 0;">
        <button onclick="manualSelectGoal()">æ‰‹åŠ¨é€‰æ‹©</button>
        <button onclick="randomGenerateGoal()">éšæœºç”Ÿæˆ</button>
      </div>

      <h3>ç›®æ ‡åˆ—è¡¨ï¼š</h3>
      <div id="goal-list" class="movie-list-grid"></div>

      <h3>å·²è§‚çœ‹ï¼š</h3>
      <div id="completed-collapsible"></div>
    </section>

    <!-- æ‰‹åŠ¨é€‰æ‹©ç›®æ ‡ æ¨¡æ€æ¡† -->
    <div id="manual-select-modal" class="modal">
      <div class="modal-content">
        <h3>è¯·é€‰æ‹©æœ¬å‘¨ç›®æ ‡ç”µå½±ï¼š</h3>
        <div id="manual-select-list"></div>
        <button onclick="confirmManualSelection()">ç¡®è®¤é€‰æ‹©</button>
        <button onclick="closeModal()">å–æ¶ˆ</button>
      </div>
    </div>

    <!-- =========== ç”µå½±æ¸…å•åŒº =========== -->
    <section id="list-section" class="section">
      <div id="stats-container">
        <div style="color: #ff7eb3;">
          ğŸ¬ æ€»ç”µå½±æ•°ï¼š<span id="total-movies">0</span>
        </div>
        <div style="color: #ffb347;">
          ğŸ“Œ æœªè§‚çœ‹ï¼š<span id="unwatched-movies">0</span>
        </div>
        <div style="color: #66cdaa;">
          âœ… å·²è§‚çœ‹ï¼š<span id="watched-movies">0</span>
        </div>
      </div>

      <div class="points-display">
        å½“å‰ç§¯åˆ†ï¼š<span id="points-value-2">0</span>
      </div>

      <!-- éšè—çš„æ–‡ä»¶ä¸Šä¼ æ§ä»¶ -->
      <input 
        type="file" 
        id="fileInput" 
        style="display: none;" 
        accept=".json"
        onchange="handleFileUpload(event)"
      />

      <h3>æœªè§‚çœ‹åˆ—è¡¨</h3>
      <!-- è¿™é‡Œæ˜¯â€œæœªè§‚çœ‹â€å¡ç‰‡å®¹å™¨ -->
      <div id="movie-list" class="movie-list-grid"></div>
    </section>
  </main>

  <!-- æ’åº/ç­›é€‰ æ¨¡æ€æ¡† -->
  <div id="sort-filter-modal">
    <div class="modal-content">
      <h3>æ’åº & ç­›é€‰</h3>
      <label>æ’åºå­—æ®µï¼š</label>
      <select id="sort-field">
        <option value="">(ä¸æ’åº)</option>
        <option value="year">å¹´ä»½</option>
        <option value="rating">è¯„åˆ†</option>
        <option value="country">å›½å®¶</option>
        <option value="genre">ç±»å‹</option>
        <option value="director">å¯¼æ¼”</option>
      </select>

      <label>é¡ºåºï¼š</label>
      <select id="sort-order">
        <option value="asc">å‡åº</option>
        <option value="desc">é™åº</option>
      </select>

      <hr/>
      <!-- ç­›é€‰å›½å®¶(å•é€‰) -->
      <label>ç­›é€‰å›½å®¶ï¼š</label>
      <select id="filter-country"></select>

      <!-- ç­›é€‰ç±»å‹(å¤šé€‰) -->
      <label>ç­›é€‰ç±»å‹ (å¯å¤šé€‰)ï¼š</label>
      <select id="filter-genre" multiple size="5" style="min-width:120px;">
      </select>

      <!-- ç­›é€‰å¯¼æ¼”(å•é€‰) -->
      <label>ç­›é€‰å¯¼æ¼”ï¼š</label>
      <select id="filter-director"></select>

      <div style="margin-top:10px;">
        <button onclick="applySortFilter()">åº”ç”¨</button>
        <button onclick="clearFilter()">æ¸…é™¤ç­›é€‰</button>
        <button onclick="closeSortFilterModal()">å…³é—­</button>
      </div>
    </div>
  </div>

  <footer>
    <!-- ä½ åŸæœ‰çš„æŒ‰é’®ä»¬ -->
    <button onclick="openFile()">ğŸ“‚ æ‰¹é‡å¯¼å…¥</button>
    <button onclick="searchMovies()">ğŸ” æœç´¢ç”µå½±</button>
    <button onclick="addMovie()">â• æ‰‹åŠ¨æ·»åŠ </button>
    <button onclick="openSortFilterModal()">ğŸ”½ æ’åº/ç­›é€‰</button>
    <button onclick="removeDuplicates()">ğŸ—‘ å»é‡</button>

    <!-- æ–°å¢â€œé‡ç½®â€æŒ‰é’® -->
    <button onclick="resetAll()">ğŸ”„é‡ç½®</button>
    <!-- ä¿ç•™åŸæœ‰â€œğŸ€æ¢è£…â€æŒ‰é’®ï¼šéšæœºåˆ‡æ¢ä¸»é¢˜ -->
    <button onclick="randomTheme()">ğŸ€æ¢è£…</button>
  </footer>

  <script>
    /* ==============================
     *  å…¨å±€å˜é‡ & æœ¬åœ°å­˜å‚¨
     * ============================== */
    let movies = [];
    let weeklyGoal = []; 
    let points = 0;

    // åªåœ¨UIæ˜¾ç¤ºæ—¶ç”¨çš„ä¸´æ—¶æ•°ç»„(ç­›é€‰/æ’åºåç»“æœ)ï¼Œä¸è¦†ç›–å…¨å±€ movies
    let currentDisplayed = []; 

    function loadData() {
      const savedMovies = localStorage.getItem("movies");
      const savedWeeklyGoal = localStorage.getItem("weeklyGoal");
      const savedPoints = localStorage.getItem("points");

      if (savedMovies) movies = JSON.parse(savedMovies);
      if (savedWeeklyGoal) weeklyGoal = JSON.parse(savedWeeklyGoal);
      if (savedPoints) points = parseInt(savedPoints, 10);
    }

    function saveData() {
      localStorage.setItem("movies", JSON.stringify(movies));
      localStorage.setItem("weeklyGoal", JSON.stringify(weeklyGoal));
      localStorage.setItem("points", points);
    }

    loadData(); // é¦–æ¬¡åŠ è½½

    /* ==============================
     *  é¡µé¢åŒºå—åˆ‡æ¢
     * ============================== */
    function showSection(sectionId) {
      document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
      document.getElementById(sectionId).classList.add('active');
    }

    /* ==============================
     *  ç§¯åˆ†æ˜¾ç¤º
     * ============================== */
    function updatePointsDisplay() {
      const el1 = document.getElementById("points-value");
      const el2 = document.getElementById("points-value-2");
      if (el1) el1.textContent = points;
      if (el2) el2.textContent = points;
    }

    /* ==============================
     *  æ¸²æŸ“â€œæœªè§‚çœ‹â€ç”µå½±æ¸…å•
     * ============================== */
    function renderMovieList(customArray) {
      const movieList = document.getElementById("movie-list");
      if (!movieList) return;

      // å¦‚æœæœ‰è‡ªå®šä¹‰æ•°ç»„ï¼Œå°±ç”¨å®ƒï¼›å¦åˆ™ç”¨å…¨å±€
      const baseArray = customArray || movies;
      // åªæ˜¾ç¤ºæœªè§‚çœ‹
      const unwatched = baseArray.filter(m => !m.watched);

      movieList.innerHTML = '';
      unwatched.forEach(movie => {
        const div = document.createElement("div");
        div.className = "movie-card";
        div.innerHTML = `
          <h4>${movie.title} (${movie.year})</h4>
          <p>${movie.country} | è¯„åˆ†ï¼š${movie.rating}</p>
          <p>ç±»å‹ï¼š${movie.genre} | å¯¼æ¼”ï¼š${movie.director}</p>
        `;

        // â€œæ ‡è®°å·²çœ‹â€
        const watchBtn = document.createElement("button");
        watchBtn.textContent = "æ ‡è®°å·²çœ‹";
        watchBtn.onclick = () => markAsWatched(movie.title);

        // â€œç¼–è¾‘â€
        const editBtn = document.createElement("button");
        editBtn.textContent = "ç¼–è¾‘";
        editBtn.onclick = () => editMovie(movie.title);

        // â€œåˆ é™¤â€
        const delBtn = document.createElement("button");
        delBtn.textContent = "åˆ é™¤";
        delBtn.onclick = () => deleteMovie(movie.title);

        div.appendChild(watchBtn);
        div.appendChild(editBtn);
        div.appendChild(delBtn);

        movieList.appendChild(div);
      });
    }

    /* ==============================
     *  æ ‡è®°å·²çœ‹
     * ============================== */
    function markAsWatched(title) {
      const today = new Date().toISOString().split('T')[0];

      movies = movies.map(movie => {
        if (movie.title === title) {
          movie.watched = true;
          movie.completedDate = today;
        }
        return movie;
      });

      points += 10; 
      alert(`å®Œæˆï¼ç§¯åˆ†+10ï¼Œæ€»ç§¯åˆ†ï¼š${points}`);

      // é‡æ–°æ¸²æŸ“
      renderMovieList(currentDisplayed.length ? currentDisplayed : null);
      renderGoalList();
      renderCompletedList();
      updateStats();
      updatePointsDisplay();
      saveData();
    }

    /* ==============================
     *  ç¼–è¾‘ç”µå½±ä¿¡æ¯
     * ============================== */
    function editMovie(title) {
      const movie = movies.find(m => m.title === title);
      if (!movie) return;

      const newTitle = prompt("ä¿®æ”¹ç”µå½±åç§°ï¼š", movie.title);
      if (!newTitle) return;

      const newYear = prompt("ä¿®æ”¹å¹´ä»½ï¼š", movie.year) || "æœªçŸ¥å¹´ä»½";
      const newCountry = prompt("ä¿®æ”¹å›½å®¶ï¼š", movie.country) || "æœªçŸ¥å›½å®¶";
      const newRating = prompt("ä¿®æ”¹è¯„åˆ†ï¼š", movie.rating) || "æ— è¯„åˆ†";
      const newGenre = prompt("ä¿®æ”¹ç±»å‹ï¼š", movie.genre) || "æœªçŸ¥ç±»å‹";
      const newDirector = prompt("ä¿®æ”¹å¯¼æ¼”ï¼š", movie.director) || "æœªçŸ¥å¯¼æ¼”";

      movies = movies.map(m => {
        if (m.title === title) {
          return {
            ...m,
            title: newTitle,
            year: newYear,
            country: newCountry,
            rating: newRating,
            genre: newGenre,
            director: newDirector
          };
        }
        return m;
      });

      alert(`å·²æ›´æ–°ç”µå½±ä¿¡æ¯ï¼š${newTitle} (${newYear})`);
      renderMovieList(currentDisplayed.length ? currentDisplayed : null);
      renderGoalList();
      renderCompletedList();
      updateStats();
      updatePointsDisplay();
      saveData();
    }

    /* ==============================
     *  åˆ é™¤ç”µå½±
     * ============================== */
    function deleteMovie(title) {
      const confirmDel = confirm(`ç¡®å®šè¦åˆ é™¤ã€Š${title}ã€‹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`);
      if (!confirmDel) return;

      // ä» movies + weeklyGoal ä¸­å½»åº•ç§»é™¤
      movies = movies.filter(m => m.title !== title);
      weeklyGoal = weeklyGoal.filter(m => m.title !== title);

      alert(`ã€Š${title}ã€‹å·²åˆ é™¤ã€‚`);
      renderMovieList(currentDisplayed.length ? currentDisplayed : null);
      renderGoalList();
      renderCompletedList();
      updateStats();
      updatePointsDisplay();
      saveData();
    }

    /* ==============================
     *  åœ¨â€œå·²è§‚çœ‹â€ä¸­è®°å½•æ„Ÿæƒ³
     * ============================== */
    function recordReview(title) {
      const movie = movies.find(m => m.title === title);
      if (!movie) return;

      const newReview = prompt("è¯·è¾“å…¥è§‚å½±æ„Ÿæƒ³ï¼š", movie.review || "");
      if (newReview === null) return;

      movies = movies.map(m => {
        if (m.title === title) {
          return { ...m, review: newReview };
        }
        return m;
      });

      alert("æ„Ÿæƒ³å·²æ›´æ–°ï¼");
      renderCompletedList();
      saveData();
    }

    /* ==============================
     *  æ¯å‘¨ç›®æ ‡: æ‰‹åŠ¨é€‰æ‹©
     * ============================== */
    function manualSelectGoal() {
      const modal = document.getElementById("manual-select-modal");
      const list = document.getElementById("manual-select-list");
      list.innerHTML = '';

      movies
        .filter(movie => !movie.watched)
        .forEach(movie => {
          const div = document.createElement("div");
          div.innerHTML = `
            <input type="checkbox" id="${movie.title}" value="${movie.title}">
            <label for="${movie.title}">${movie.title} (${movie.year})</label>
          `;
          list.appendChild(div);
        });

      modal.style.display = "block";
    }

    function confirmManualSelection() {
      const modal = document.getElementById("manual-select-modal");
      const checkboxes = document.querySelectorAll("#manual-select-list input[type='checkbox']:checked");
      const selectedTitles = Array.from(checkboxes).map(checkbox => checkbox.value);

      weeklyGoal = [];

      const deadlineInput = document.getElementById("deadline").value;
      const fallback = new Date();
      fallback.setDate(fallback.getDate() + 7);
      const finalDeadline = deadlineInput ? new Date(deadlineInput) : fallback;

      selectedTitles.forEach(title => {
        const movie = movies.find(m => m.title === title);
        if (movie) {
          weeklyGoal.push({
            ...movie,
            deadline: finalDeadline.toISOString().split('T')[0]
          });
        }
      });

      modal.style.display = "none";
      renderGoalList();
      saveData();
    }

    function closeModal() {
      document.getElementById("manual-select-modal").style.display = "none";
    }

    /* ==============================
     *  éšæœºç”Ÿæˆç›®æ ‡
     * ============================== */
    function randomGenerateGoal() {
      const goalNumber = parseInt(document.getElementById('weekly-goal').value);
      if (!goalNumber || goalNumber <= 0) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ç›®æ ‡æ•°é‡ï¼");
        return;
      }

      const deadlineInput = document.getElementById("deadline").value;
      const fallback = new Date();
      fallback.setDate(fallback.getDate() + 7);
      const finalDeadline = deadlineInput ? new Date(deadlineInput) : fallback;

      const candidates = movies.filter(movie => !movie.watched);
      candidates.sort(() => Math.random() - 0.5);
      const chosen = candidates.slice(0, goalNumber);

      weeklyGoal = chosen.map(m => ({
        ...m,
        deadline: finalDeadline.toISOString().split('T')[0]
      }));

      renderGoalList();
      saveData();
    }

    /* ==============================
     *  æ¸²æŸ“ç›®æ ‡åˆ—è¡¨ (å«é€¾æœŸæç¤º)
     * ============================== */
    function renderGoalList() {
      const goalList = document.getElementById("goal-list");
      if (!goalList) return;
      goalList.innerHTML = '';

      const now = new Date();

      weeklyGoal.forEach(movie => {
        const div = document.createElement("div");
        div.className = 'movie-card';

        let info = '';
        if (movie.deadline) {
          const dl = new Date(movie.deadline);
          const diffTime = dl - now;
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          if (diffDays > 0) {
            info = `è¿˜å‰©${diffDays}å¤©åˆ°æœŸ`;
          } else {
            info = `å·²é€¾æœŸ${Math.abs(diffDays)}å¤©`;
            div.classList.add("expired");
          }
        } else {
          info = 'æ— æˆªæ­¢æ—¥æœŸ';
        }

        div.innerHTML = `
          <h3>${movie.title} (${movie.year})</h3>
          <p>ç±»å‹ï¼š${movie.genre} | å¯¼æ¼”ï¼š${movie.director}</p>
          <p>æˆªæ­¢ï¼š<span>${movie.deadline || 'æ— '}</span> / ${info}</p>
        `;

        const btnComplete = document.createElement("button");
        btnComplete.textContent = "å®Œæˆ";
        btnComplete.onclick = () => completeGoal(movie.title);

        const btnSkip = document.createElement("button");
        btnSkip.textContent = "è·³è¿‡(-5åˆ†)";
        btnSkip.onclick = () => skipGoal(movie.title);

        div.appendChild(btnComplete);
        div.appendChild(btnSkip);
        goalList.appendChild(div);
      });
    }

    /* ==============================
     *  å®Œæˆ/è·³è¿‡ ç›®æ ‡
     * ============================== */
    function completeGoal(title) {
      const today = new Date().toISOString().split('T')[0];
      const goalItem = weeklyGoal.find(m => m.title === title);
      const nowStr = new Date().toISOString().split('T')[0];
      let expiredFlag = false;
      if (goalItem && goalItem.deadline) {
        expiredFlag = (nowStr > goalItem.deadline);
      }

      // moviesé‡Œæ ‡è®°å·²çœ‹
      movies = movies.map(movie => {
        if (movie.title === title) {
          movie.watched = true;
          movie.completedDate = today;
        }
        return movie;
      });
      // weeklyGoal é‡Œç§»é™¤
      weeklyGoal = weeklyGoal.filter(m => m.title !== title);

      if (!expiredFlag) {
        points += 10;
        alert(`å®Œæˆï¼ç§¯åˆ†+10ï¼Œæ€»ç§¯åˆ†ï¼š${points}`);
      } else {
        alert("å®Œæˆï¼Œä½†å·²è¶…è¿‡æˆªæ­¢æ—¥æœŸï¼Œæœªè·å¾—ç§¯åˆ†ã€‚");
      }

      renderMovieList(currentDisplayed.length ? currentDisplayed : null);
      renderGoalList();
      renderCompletedList();
      updateStats();
      updatePointsDisplay();
      saveData();
    }

    function skipGoal(title) {
      alert(`è·³è¿‡ã€Š${title}ã€‹ï¼Œæ‰£é™¤5åˆ†ã€‚`);
      points -= 5;
      weeklyGoal = weeklyGoal.filter(m => m.title !== title);

      renderGoalList();
      updateStats();
      updatePointsDisplay();
      saveData();
    }

    /* ==============================
     *  æ¸²æŸ“å·²è§‚çœ‹åˆ—è¡¨ (æŠ˜å )
     * ============================== */
    function renderCompletedList() {
      const container = document.getElementById("completed-collapsible");
      if (!container) return;
      container.innerHTML = '';

      const watchedMovies = movies.filter(m => m.watched);
      const groups = {};
      watchedMovies.forEach(m => {
        const d = m.completedDate || "æœªçŸ¥æ—¥æœŸ";
        if (!groups[d]) groups[d] = [];
        groups[d].push(m);
      });

      // æ—¥æœŸé™åº
      Object.keys(groups)
        .sort((a, b) => b.localeCompare(a))
        .forEach(dateStr => {
          const header = document.createElement("div");
          header.className = "collapsible-header";
          header.textContent = `${dateStr} å®Œæˆ (${groups[dateStr].length}éƒ¨)`;
          header.onclick = () => {
            content.classList.toggle("show");
          };

          const content = document.createElement("div");
          content.className = "collapsible-content";
          const grid = document.createElement("div");
          grid.className = "movie-list-grid";

          groups[dateStr].forEach(movie => {
            const div = document.createElement("div");
            div.className = "movie-card";
            
            let html = `
              <h4>${movie.title} (${movie.year})</h4>
              <p>${movie.country} | è¯„åˆ†ï¼š${movie.rating}</p>
              <p>ç±»å‹ï¼š${movie.genre} | å¯¼æ¼”ï¼š${movie.director}</p>
              <p>å®Œæˆäºï¼š${movie.completedDate}</p>
            `;
            if (movie.review) {
              html += `<div class="review-text">è§‚å½±æ„Ÿæƒ³ï¼š${movie.review}</div>`;
            }
            div.innerHTML = html;

            const editBtn = document.createElement("button");
            editBtn.textContent = "ç¼–è¾‘";
            editBtn.onclick = () => editMovie(movie.title);

            const delBtn = document.createElement("button");
            delBtn.textContent = "åˆ é™¤";
            delBtn.onclick = () => deleteMovie(movie.title);

            const reviewBtn = document.createElement("button");
            reviewBtn.textContent = "æ„Ÿæƒ³";
            reviewBtn.onclick = () => recordReview(movie.title);

            div.appendChild(editBtn);
            div.appendChild(delBtn);
            div.appendChild(reviewBtn);

            grid.appendChild(div);
          });

          content.appendChild(grid);
          container.appendChild(header);
          container.appendChild(content);
        });
    }

    /* ==============================
     *  æ‰¹é‡å¯¼å…¥ & å»é‡
     * ============================== */
    function openFile() {
      document.getElementById('fileInput').click();
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const importedMovies = JSON.parse(e.target.result);
          if (Array.isArray(importedMovies)) {
            movies = movies.concat(
              importedMovies.map(movie => ({
                title: movie.title || "æœªå‘½åç”µå½±",
                year: movie.year || "æœªçŸ¥å¹´ä»½",
                country: movie.country || "æœªçŸ¥å›½å®¶",
                rating: movie.rating || "æ— è¯„åˆ†",
                genre: movie.genre || "æœªçŸ¥ç±»å‹",
                director: movie.director || "æœªçŸ¥å¯¼æ¼”",
                watched: movie.watched || false,
                review: movie.review || "",
                completedDate: movie.completedDate || ""
              }))
            );
            alert("ç”µå½±æ¸…å•å¯¼å…¥æˆåŠŸï¼");
            removeDuplicates(false);
            renderMovieList();
            renderGoalList();
            renderCompletedList();
            updateStats();
            updatePointsDisplay();
            saveData();
          } else {
            throw new Error("JSON æ ¼å¼é”™è¯¯");
          }
        } catch (error) {
          alert("å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ï¼");
        }
      };
      reader.readAsText(file);
    }

    function removeDuplicates(showAlert = true) {
      const uniqueMap = new Map();
      const newArr = [];
      for (let m of movies) {
        const key = m.title + '##' + m.year;
        if (!uniqueMap.has(key)) {
          uniqueMap.set(key, true);
          newArr.push(m);
        }
      }

      const removedCount = movies.length - newArr.length;
      movies = newArr;
      // weeklyGoal ä¹Ÿè¦å»é‡
      weeklyGoal = weeklyGoal.filter(m => {
        const key = m.title + '##' + m.year;
        return uniqueMap.has(key);
      });

      if (showAlert) {
        if (removedCount > 0) {
          alert(`å·²æ¸…ç† ${removedCount} æ¡é‡å¤ç”µå½±ã€‚`);
        } else {
          alert("æœªå‘ç°é‡å¤ç”µå½±ã€‚");
        }
      }

      renderMovieList();
      renderGoalList();
      renderCompletedList();
      updateStats();
      updatePointsDisplay();
      saveData();
    }

    /* ==============================
     *  ç»Ÿè®¡æ•°æ®
     * ============================== */
    function updateStats() {
      const totalMovies = movies.length;
      const watchedMovies = movies.filter(movie => movie.watched).length;
      const unwatchedMovies = totalMovies - watchedMovies;

      const tm = document.getElementById('total-movies');
      const wm = document.getElementById('watched-movies');
      const um = document.getElementById('unwatched-movies');

      if (tm) tm.textContent = totalMovies;
      if (wm) wm.textContent = watchedMovies;
      if (um) um.textContent = unwatchedMovies;
    }

    /* ==============================
     *  æœç´¢ç”µå½±
     * ============================== */
    function searchMovies() {
      const query = prompt("è¯·è¾“å…¥è¦æœç´¢çš„ç”µå½±åï¼ˆå…³é”®è¯ï¼‰ï¼š");
      if (!query) return;

      document.querySelectorAll(".highlight").forEach(el => el.classList.remove('highlight'));

      const found = movies.find(m => m.title.includes(query));
      if (!found) {
        alert("æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ç”µå½±ã€‚");
        return;
      }

      alert(`æ‰¾åˆ°ç”µå½±ï¼š${found.title} (${found.year})ï¼Œæ­£åœ¨å®šä½...`);

      if (!found.watched) {
        // åœ¨æœªè§‚çœ‹åˆ—è¡¨
        showSection('list-section');
        renderMovieList(); 
        const cards = document.querySelectorAll("#movie-list .movie-card");
        for (let card of cards) {
          const h4 = card.querySelector("h4");
          if (h4 && h4.textContent.includes(found.title)) {
            card.classList.add("highlight");
            card.scrollIntoView({ behavior: "smooth", block: "center" });
            break;
          }
        }
      } else {
        // åœ¨å·²è§‚çœ‹
        showSection('goal-section');
        renderCompletedList(); 
        const dateStr = found.completedDate || "æœªçŸ¥æ—¥æœŸ";
        const headers = document.querySelectorAll("#completed-collapsible .collapsible-header");
        const contents = document.querySelectorAll("#completed-collapsible .collapsible-content");
        for (let i = 0; i < headers.length; i++) {
          if (headers[i].textContent.includes(dateStr)) {
            if (!contents[i].classList.contains("show")) {
              contents[i].classList.add("show");
            }
            const cards = contents[i].querySelectorAll(".movie-card");
            for (let c of cards) {
              const hh4 = c.querySelector("h4");
              if (hh4 && hh4.textContent.includes(found.title)) {
                c.classList.add("highlight");
                c.scrollIntoView({ behavior: "smooth", block: "center" });
                break;
              }
            }
            break;
          }
        }
      }
    }

    /* ==============================
     *  æ‰‹åŠ¨æ·»åŠ ç”µå½±(åŒ…å«ç±»å‹ã€å¯¼æ¼”)
     * ============================== */
    function addMovie() {
      /*
        æ ¼å¼: "æ ‡é¢˜/å¹´ä»½/å›½å®¶/è¯„åˆ†/ç±»å‹/å¯¼æ¼”"
        ä¾‹: å¯„ç”Ÿè™«/2019/éŸ©å›½/8.7/å‰§æƒ…/å¥‰ä¿Šæ˜Š
      */
      const line = prompt("è¯·è¾“å…¥ç”µå½±ä¿¡æ¯ï¼ˆæ ‡é¢˜/å¹´ä»½/å›½å®¶/è¯„åˆ†/ç±»å‹/å¯¼æ¼”ï¼‰ï¼š");
      if (!line) return;

      const parts = line.split('/');
      const title = parts[0]?.trim() || "";
      const year = parts[1]?.trim() || "æœªçŸ¥å¹´ä»½";
      const country = parts[2]?.trim() || "æœªçŸ¥å›½å®¶";
      const rating = parts[3]?.trim() || "æ— è¯„åˆ†";
      const genre = parts[4]?.trim() || "æœªçŸ¥ç±»å‹";
      const director = parts[5]?.trim() || "æœªçŸ¥å¯¼æ¼”";

      if (!title) {
        alert("ç”µå½±æ ‡é¢˜ä¸èƒ½ä¸ºç©ºï¼Œå·²å–æ¶ˆæ“ä½œã€‚");
        return;
      }

      const duplicate = movies.find(m => m.title === title && m.year === year);
      if (duplicate) {
        alert(`å·²å­˜åœ¨åŒååŒå¹´ç”µå½±ã€Š${title} (${year})ã€‹ï¼Œå·²è·³è¿‡ã€‚`);
        return;
      }

      const newMovie = {
        title,
        year,
        country,
        rating,
        genre,
        director,
        watched: false,
        review: "",
        completedDate: ""
      };

      movies.push(newMovie);
      alert(`æˆåŠŸæ·»åŠ ï¼šã€Š${title}ã€‹ï¼`);
      renderMovieList(currentDisplayed.length ? currentDisplayed : null);
      updateStats();
      updatePointsDisplay();
      saveData();
    }

    /* ==============================
     *  æ’åº/ç­›é€‰
     * ============================== */
    function openSortFilterModal() {
      populateFilterOptions();
      document.getElementById("sort-filter-modal").style.display = "block";
    }

    function closeSortFilterModal() {
      document.getElementById("sort-filter-modal").style.display = "none";
    }

    function populateFilterOptions() {
      const countrySelect = document.getElementById("filter-country");
      const genreSelect = document.getElementById("filter-genre");
      const directorSelect = document.getElementById("filter-director");

      countrySelect.innerHTML = '';
      genreSelect.innerHTML = '';
      directorSelect.innerHTML = '';

      countrySelect.appendChild(new Option("(ä¸é™)", ""));
      directorSelect.appendChild(new Option("(ä¸é™)", ""));

      const countries = [...new Set(movies.map(m => m.country))];
      const genres = [...new Set(movies.map(m => m.genre))];
      const directors = [...new Set(movies.map(m => m.director))];

      countries.forEach(c => {
        countrySelect.appendChild(new Option(c, c));
      });
      genres.forEach(g => {
        genreSelect.appendChild(new Option(g, g));
      });
      directors.forEach(d => {
        directorSelect.appendChild(new Option(d, d));
      });
    }

    function getMultiSelectValues(selectEl) {
      return Array.from(selectEl.selectedOptions).map(o => o.value);
    }

    function applySortFilter() {
      const sortField = document.getElementById("sort-field").value;
      const sortOrder = document.getElementById("sort-order").value;

      const filterCountry = document.getElementById("filter-country").value;
      const filterDirector = document.getElementById("filter-director").value;

      const selectedGenres = getMultiSelectValues(document.getElementById("filter-genre"));

      let result = [...movies];

      if (filterCountry) {
        result = result.filter(m => m.country === filterCountry);
      }
      if (selectedGenres.length > 0) {
        result = result.filter(m => selectedGenres.includes(m.genre));
      }
      if (filterDirector) {
        result = result.filter(m => m.director === filterDirector);
      }

      if (sortField) {
        result.sort((a, b) => {
          let valA = a[sortField];
          let valB = b[sortField];

          if (sortField === "year" || sortField === "rating") {
            valA = parseFloat(valA) || 0;
            valB = parseFloat(valB) || 0;
          }

          if (sortOrder === "asc") {
            return valA < valB ? -1 : (valA > valB ? 1 : 0);
          } else {
            return valA > valB ? -1 : (valA < valB ? 1 : 0);
          }
        });
      }

      currentDisplayed = result;
      renderMovieList(currentDisplayed);
      closeSortFilterModal();
    }

    function clearFilter() {
      currentDisplayed = [];
      renderMovieList();
      closeSortFilterModal();
    }

    /* ==============================
     *  é‡ç½®åŠŸèƒ½
     * ============================== */
    function resetAll() {
      const confirmReset = confirm("ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ•°æ®å—ï¼Ÿå°†æ¸…ç©ºæœ¬åœ°å­˜å‚¨å¹¶åˆ·æ–°é¡µé¢ã€‚");
      if (!confirmReset) return;
      localStorage.clear();
      location.reload();
    }

    /* ==============================
     *  æ¢è£…åŠŸèƒ½ï¼ˆå«æ–°å¢é«˜çº§æ„Ÿä¸»é¢˜ï¼‰
     * ============================== */
    const themeList = [
      "",             // 1. ç©ºå­—ç¬¦ä¸² => é»˜è®¤ç²‰è‰²
      "theme-blue",   // 2. åŸæœ‰è“è‰²
      "theme-green",  // 3. åŸæœ‰ç»¿è‰²
      "theme-dark",   // 4. åŸæœ‰æš—è‰²
      "theme-adv1",   // 5. æ–°å¢é«˜çº§æ„Ÿ1
      "theme-adv2",   // 6. æ–°å¢é«˜çº§æ„Ÿ2
      "theme-adv3",   // 7. æ–°å¢é«˜çº§æ„Ÿ3
      "theme-adv4",   // 8. æ–°å¢é«˜çº§æ„Ÿ4
      "theme-adv5"    // 9. æ–°å¢é«˜çº§æ„Ÿ5
    ];

    function randomTheme() {
      // å…ˆæ¸…é™¤æ‰€æœ‰ä¸»é¢˜ç±»
      document.body.classList.remove(
        "theme-blue", "theme-green", "theme-dark",
        "theme-adv1", "theme-adv2", "theme-adv3", "theme-adv4", "theme-adv5"
      );
      // éšæœºæŒ‘é€‰å¹¶åº”ç”¨
      const rand = Math.floor(Math.random() * themeList.length);
      const chosen = themeList[rand];
      if (chosen) {
        document.body.classList.add(chosen);
      }
    }

    /* ==============================
     *  åˆå§‹åŒ–
     * ============================== */
    function init() {
      currentDisplayed = [];
      renderMovieList();
      renderGoalList();
      renderCompletedList();
      updateStats();
      updatePointsDisplay();
    }

    init();
  </script>

  <!-- Service Worker æ³¨å†Œï¼ˆè‹¥éœ€è¦ï¼Œå¯è‡ªè¡Œè§£å¼€æ³¨é‡Šå¹¶ç¼–å†™å¯¹åº” service-worker.jsï¼‰
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .then(reg => console.log('SW æ³¨å†ŒæˆåŠŸ:', reg))
          .catch(err => console.log('SW æ³¨å†Œå¤±è´¥:', err));
      });
    }
  </script>
  -->
</body>
</html>